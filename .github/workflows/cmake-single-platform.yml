# Windows x64 only — build + package + create draft Release
# Trigger: push tag like v1.2.3
on:
  push:
    tags:
      - 'v*'

env:
  BUILD_TYPE: Release

jobs:
  build-and-release:
    name: Build & Release (windows-x64)
    runs-on: windows-latest
    env:
      VERSION: ${{ github.ref_name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install prerequisites (choco)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          choco install -y git --no-progress || Write-Host 'git already present'
          choco install -y 7zip --no-progress || Write-Host '7zip already present'
          choco install -y cmake --no-progress || Write-Host 'cmake already present'

      - name: Setup vcpkg and install libraries (libuv, openssl)
        shell: pwsh
        run: |
          git clone --depth 1 https://github.com/microsoft/vcpkg.git vcpkg
          .\vcpkg\bootstrap-vcpkg.bat
          # 使用动态 triplet（x64-windows），生成 uv.dll 等动态库
          .\vcpkg\vcpkg.exe install libuv:x64-windows openssl:x64-windows
          .\vcpkg\vcpkg.exe integrate install

      - name: Configure (CMake) using vcpkg toolchain
        shell: pwsh
        run: |
          $vcpkgToolchain = (Resolve-Path .\vcpkg\scripts\buildsystems\vcpkg.cmake).Path
          Write-Host "Using vcpkg toolchain: $vcpkgToolchain"
          # 强制使用 Release 配置的 MSVC 运行时（非 Debug）
          cmake -S . -B build -A x64 -DCMAKE_BUILD_TYPE=$env:BUILD_TYPE -DCMAKE_TOOLCHAIN_FILE="$vcpkgToolchain" -DVCPKG_TARGET_TRIPLET=x64-windows -DWITH_HWLOC=OFF -DWITH_OPENSSL=ON -DCMAKE_MSVC_RUNTIME_LIBRARY=MultiThreadedDLL

      - name: Build (MSBuild/CMake)
        shell: pwsh
        run: |
          cmake --build build --config $env:BUILD_TYPE -- /m

      - name: Prepare dist folder and collect artifacts (include vcpkg dlls)
        shell: pwsh
        run: |
          $version = if ($env:VERSION) { $env:VERSION } else { 'unknown' }
          $name = "xmrig-$version-windows-x64"
          New-Item -Path dist -ItemType Directory -Force | Out-Null

          # 找到编译出的 exe（可根据目标名调整）
          $bins = Get-ChildItem -Path build -Filter '*.exe' -Recurse -ErrorAction SilentlyContinue | Select-Object -ExpandProperty FullName
          if (-not $bins) {
            Write-Host "No exe found under build/, will package whole build folder."
            $bins = Get-ChildItem -Path build -Recurse | Select-Object -ExpandProperty FullName
          }

          # repo 根的额外文件
          $extras = @()
          foreach ($f in @('LICENSE','LICENSE.txt','README.md','config.json')) {
            if (Test-Path $f) { $extras += (Resolve-Path $f).Path }
          }

          # 把 vcpkg 安装目录下的 DLL 一并收集（x64-windows 动态库）
          $vcpkgDlls = @()
          $vcpkgBin = Join-Path $PWD "vcpkg\installed\x64-windows\bin"
          if (Test-Path $vcpkgBin) {
            $vcpkgDlls = Get-ChildItem -Path $vcpkgBin -Filter '*.dll' -ErrorAction SilentlyContinue | Select-Object -ExpandProperty FullName
          }

          # 有些库把 DLL 放到 libexec 或 tools 子目录，额外尝试查找
          $extraBins = Get-ChildItem -Path (Join-Path $PWD "vcpkg\installed\x64-windows") -Recurse -Include '*.dll' -ErrorAction SilentlyContinue | Select-Object -ExpandProperty FullName
          if ($extraBins) { $vcpkgDlls += $extraBins }

          # 过滤掉明显的 Debug DLL（名称以 d.dll 结尾），避免把 debug 依赖打包进 release
          $vcpkgDlls = $vcpkgDlls | Where-Object { $_ -notmatch '[dD]\.dll$' }

          # 将 DLL 以及 exe/其它文件复制到 dist/flat 目录（便于运行和打包）
          $flatDir = Join-Path (Resolve-Path .\dist).Path "package"
          if (Test-Path $flatDir) { Remove-Item $flatDir -Recurse -Force }
          New-Item -Path $flatDir -ItemType Directory -Force | Out-Null

          $filesToCopy = ($bins + $extras + $vcpkgDlls) | Select-Object -Unique | Where-Object { Test-Path $_ }
          foreach ($file in $filesToCopy) {
            Copy-Item -Path $file -Destination $flatDir -Force
          }

          # 如果你希望把 exe 放在子目录（比如 bin/），可以在这里调整结构
          $zipPath = Join-Path -Path (Resolve-Path dist) -ChildPath "$name.zip"
          Compress-Archive -Path (Join-Path $flatDir '*') -DestinationPath $zipPath -Force

          Write-Host "Created: $zipPath"
          Get-ChildItem dist | Write-Host

      - name: Upload build artifact (for debug / downloads)
        uses: actions/upload-artifact@v4
        with:
          name: windows-x64-build
          path: dist/*

      - name: Create draft GitHub Release and attach assets
        # draft: true to avoid immediate public publish; change to false to auto-publish
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: |
            Release built by CI (windows-x64). Attachments included.
          draft: true
          artifacts: dist/* 
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
