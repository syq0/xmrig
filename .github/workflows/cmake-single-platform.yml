# Windows x64 only — build + package + create draft Release
# Trigger: push tag like v1.2.3
on:
  push:
    tags:
      - 'v*'

env:
  BUILD_TYPE: Release

jobs:
  build-and-release:
    name: Build & Release (windows-x64)
    runs-on: windows-latest
    env:
      VERSION: ${{ github.ref_name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install prerequisites (choco)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          choco install -y cmake --no-progress || Write-Host 'cmake already present'
          # Add other packages if your build needs them, e.g. openssl, 7zip, etc.

      - name: Configure (CMake)
        shell: pwsh
        run: |
          # Configure for x64 Release. Adjust -D flags as needed for xmrig.
          cmake -S . -B build -A x64 -DCMAKE_BUILD_TYPE=$env:BUILD_TYPE -DWITH_HWLOC=ON -DWITH_OPENSSL=ON
      - name: Build (MSBuild/CMake)
        shell: pwsh
        run: |
          cmake --build build --config ${env:BUILD_TYPE} -- /m

      - name: Prepare dist folder and collect artifacts
        shell: pwsh
        run: |
          $version = if ($env:VERSION) { $env:VERSION } else { 'unknown' }
          $name = "xmrig-$version-windows-x64"
          New-Item -Path dist -ItemType Directory -Force | Out-Null

          # Try to find built executables (adjust pattern if your target binary name differs)
          $bins = Get-ChildItem -Path build -Filter '*.exe' -Recurse -ErrorAction SilentlyContinue | Select-Object -ExpandProperty FullName
          if (-not $bins) {
            # fallback: include entire build output
            Write-Host "No exe found under build/, will package whole build folder."
            $bins = Get-ChildItem -Path build -Recurse | Select-Object -ExpandProperty FullName
          }

          # Include LICENSE/README if present at repo root
          $extras = @()
          foreach ($f in @('LICENSE','LICENSE.txt','README.md','config.json')) {
            if (Test-Path $f) { $extras += (Resolve-Path $f).Path }
          }

          $all = $bins + $extras
          $zipPath = Join-Path -Path (Resolve-Path dist) -ChildPath "$name.zip"

          # Compress-Archive may fail if files list is empty — handle accordingly
          if ($all) {
            Compress-Archive -Path $all -DestinationPath $zipPath -Force
          } else {
            # create empty zip of build folder
            Compress-Archive -Path build\* -DestinationPath $zipPath -Force
          }

          Write-Host "Created: $zipPath"
          Get-ChildItem dist | Write-Host

      - name: Upload build artifact (for debug / downloads)
        uses: actions/upload-artifact@v4
        with:
          name: windows-x64-build
          path: dist/*

      - name: Create draft GitHub Release and attach assets
        # draft: true to avoid immediate public publish; change to false to auto-publish
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: |
            Release built by CI (windows-x64). Attachments included.
          draft: true
          artifacts: dist/* 
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
